### [get_creds_CVE-2024-23897.py](get_creds_CVE-2024-23897.py)

This script perform the attack described in [Jenkins Security Advisory 2024-01-24](https://www.jenkins.io/security/advisory/2024-01-24/)
- Decrypt secrets stored in Jenkins

When Jenkins is used in production or testing environments, sometimes an internal authentication is necessary to extract information from third parties or other applications. Administrators may create "credentials" for use with the scripts that are executed by Jenkins. These credentials can have high priveleges and can be used in other systems due to "password reuse". The script provided here enables the download of essential files required to decrypt these passwords, all without any authentication. This poses a security concern as it allows unauthorized access to potentially sensitive information stored within Jenkins.
![get_creds_CVE-2024-23897_1](/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_1.png)


This script performs the following steps:
1. Checks connection with a Jenkins server
2. Checks authorization level of anonymous user (Read or No Read permissions)
3. Checks the Jenkins installation folder
4. Downloads hudson.util.Secret file
5. Downloads InstanceIdentity key file (if necessary)
6. Downloads master.key file
7. Downloads credentials.xml file (if permissions are available)
8. Extract usernames and passwords from credentials.xml
9. Decrypt found passwords
10. Repairs hudson.util.Secret (if necessary)

To be able to decrypt credential passwords, certain conditions must be met:
1. Anonymous user with Overall/Read permissions
2. Java with Cp1252 file.encoding configuration
3. [Credentials plugin](https://plugins.jenkins.io/credentials/) installed
4. Any credentials that actually exists

Usage:\
python3 ./get_creds_CVE-2024-23897.py -w URL
![get_creds_CVE-2024-23897_2](/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_2.png)


The authorization level for an anonymous user can be configured on the "Global Security Configuration." For monitoring purposes, the anonymous user can be set with "Read Only" permissions, allowing access to specific addresses and functions through the CLI. If read access is granted to the anonymous user, this script can read the "Credentials.xml" file and decrypt passwords. Even if anonymous users are not enabled, the secret binary files can still be downloaded, enabling further password decryption using the following script:\
[Decrypt Jenkins secrets offline](https://github.com/gquere/pwn_jenkins/tree/master?tab=readme-ov-file#decrypt-jenkins-secrets-offline | width=50%) **Props to gquere!**
<img src="/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_3.png" width=50% height=50%>

To successfully read the binary files, it depends on the configured file.encoding type in Java. Jenkins, being a Java application, is [compatible with Java](https://www.jenkins.io/doc/book/platform-information/support-policy-java/) versions 21, 17, and 11. Despite this, the latest Jenkins version (2.441) can be installed with Java 17. The crucial point is that the default encoding changes to UTF-8 in Java 21, whereas in versions 17 or 11, the encoding type remains as Cp1252. Binary files can be read if the encoding type is Cp1252, which is the default configuration for Java (17 and 11) installations on Windows. However, in Linux, the default encoding is UTF-8. It's worth noting that even with Java 21 or any Java version in Linux, this configuration can be overridden. This might be the case when Jenkins administrators encounter issues reading certain encoded files within Jenkins.
![get_creds_CVE-2024-23897_4](/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_4.png)


This script was tested in different Jenkins versions:\

Jenkins 2.441 on Windows 10 and Java 17:
![get_creds_CVE-2024-23897_5](/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_5.png)


Jenkins 2.150.2 on Windows 10 and Java 11:
![get_creds_CVE-2024-23897_6](/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_6.png)


Jenkins 2.441 on Ubuntu Linux 22.04.3 and Java 21 (after setting file.encoding to Cp1252):
![get_creds_CVE-2024-23897_7](/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_7.png)
Cracking passwords on Linux is more challenging because binary files cannot always be downloaded in the proper format. However, it was successful in 50% of my tests. In the screenshot above, the script had to download a second binary file (InstanceIdentity key) that contains the same last bytes as the first binary file and consequently builds a file from both. Despite using this technique, the decryption process failed. As a result, the script brute forces the last byte of the binary file in an attempt to guess it.


### How to change file.encoding on Jenkins:/

Windows on Java 21:/
1. Stop Jenkins service
2. Edit the file "C:\Program Files\ Jenkins\jenkins.xml"
3. Add "-Dfile.encoding=Cp1252" to <arguments> line
4. Start Jenkins service
![get_creds_CVE-2024-23897_8](/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_8.png)


Linux:/
1. Stop Jenkins service
2. Edit the file "/lib/systemd/system/jenkins.service"
3. Add this option to JAVA_OPTS "-Dfile.encoding=Cp1252 "/
sed -i 's/\(JAVA_OPTS=\)/\1-Dfile.encoding=Cp1252 /' /lib/systemd/system/jenkins.service
4. Reload services daemon
5. Start Jenkins service
![get_creds_CVE-2024-23897_9](/get_creds_CVE-2024-23897.py/images/get_creds_CVE-2024-23897_9.png)



Recomendations to mitigate this vuln:\
1. Disable anonymous user read access
2. If is necessary, create a new user with read access using matrix-based authentication
3. Disable CLI access if you are not using it
4. Check file.encoding in Jenkins, change it to UTF-8 if possible
5. Update Java, Jenkins core and Jenkins plugins to latest versions
